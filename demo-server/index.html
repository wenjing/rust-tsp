<!DOCTYPE html>
<html>
<head>
  <title>TSP Demo Server</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <style>
    html,
    body,
    body > .container-fluid,
    body > .container-fluid > .row,
    body > .container-fluid > .row > div {
      height: 100%;
    }
    .message-part {
      font-family: monospace;
    }
  </style>
  <script>
    async function sha256(source) {
      const sourceBytes = new TextEncoder().encode(source);
      const digest = await crypto.subtle.digest('SHA-256', sourceBytes);
      const resultBytes = [...new Uint8Array(digest)];

      return resultBytes.map((x) => x.toString(16).padStart(2, '0')).join("");
    }

    function base64URLdecode(str) {
      const base64Encoded = str.replace(/-/g, '+').replace(/_/g, '/');
      const padding = str.length % 4 === 0 ? '' : '='.repeat(4 - (str.length % 4));
      const base64WithPadding = base64Encoded + padding;

      return atob(base64WithPadding)
        .split('')
        .map(char => String.fromCharCode(char.charCodeAt(0)))
        .join('');
    }

    document.addEventListener('DOMContentLoaded', () => {

      // update identities + rendering
      const updateIdentities = async () => {
        const identities = Object.keys(window.localStorage).reduce((acc, item) => {
          if (item.startsWith('did:')) {
            let identity = JSON.parse(window.localStorage.getItem(item));
            const key = identity.id;

            return {
              [key]: identity,
              ...acc
            };
          }

          return acc;
        }, {});

        const cards = document.querySelector('.cards');

        if (Object.values(identities).length === 0) {
          cards.innerHTML = `
            <div class="text-muted p-3">
              <em>None</em>
            </div>`;
        } else {
          cards.innerHTML = '';
        }

        Object.values(identities).forEach((identity) => {
          const card = document.createElement('div');
          card.classList.add('col');
          card.innerHTML = `
            <div class="card mb-4 text-bg-light" style="max-width:40rem">
              <div class="card-body">
                <h5 class="card-title">
                  ${identity.sigkey ? 'Private' : 'Public'} VID
                </h5>
                <input type="text" value="${identity.id}" class="form-control-plaintext" readonly />
              </div>
              <ul class="list-group list-group-flush">
                ${identity.sigkey ? `
                <li class="list-group-item">
                    <span class="badge text-bg-warning float-end">private</span>
                    <span class="text-muted d-block mb-2">Decryption key:</span>
                    <pre class="text-warning-emphasis mb-0">${identity.enckey}</pre>
                </li>
                <li class="list-group-item">
                    <span class="badge text-bg-warning float-end">private</span>
                    <span class="text-muted d-block mb-2">Signing key:</span>
                    <pre class="text-warning-emphasis mb-0">${identity.sigkey}</pre>
                </li>
                ` : ''}
                <li class="list-group-item">
                    <span class="badge text-bg-info float-end">public</span>
                    <span class="text-muted d-block mb-2">Verification key:</span>
                    <pre class="text-primary-emphasis mb-0">${identity.publicSigkey}</pre>
                </li>
                <li class="list-group-item">
                    <span class="badge text-bg-info float-end">public</span>
                    <span class="text-muted d-block mb-2">Encryption key:</span>
                    <pre class="text-primary-emphasis mb-0">${identity.publicEnckey}</pre>
                </li>
                <li class="list-group-item">
                  <span class="text-muted d-block mb-2">Transport:</span>
                  <pre class="text-primary-emphasis mb-0">${identity.transport}</pre>
                </li>
              </ul>
              <div class="card-body">
                <button role="button" class="btn btn-danger delete float-end">Delete</button>
                ${identity.sigkey ? `
                  <button role="button" class="btn btn-warning select-sender">Select sender</button>
                ` : ''}
                <button role="button" class="btn btn-info select-receiver">Select receiver</button>
              </div>
            </div>`;

          card.querySelector('.delete').addEventListener('click', (event) => {
            event.preventDefault();
            window.localStorage.removeItem(identity.id);
            updateIdentities();
          });

          const selectSender = card.querySelector('.select-sender');
          if (selectSender) {
            selectSender.addEventListener('click', (event) => {
              event.preventDefault();
              document.getElementById('sender').value = identity.id;
            });
          }

          card.querySelector('.select-receiver').addEventListener('click', (event) => {
            event.preventDefault();
            document.getElementById('receiver').value = identity.id;
            document.getElementById('message-receiver').value = identity.id;
          });

          cards.appendChild(card);
        });
      };

      function renderMessage(message) {
        const card = document.createElement('div');
        card.classList.add('col');

        const parts = [];
        let position = 0;
        let next_position = 8;
        let data = '';

        parts.push({
          title: 'Prefix',
          color: '#800000',
          prefix: 8,
          data: message.message.slice(position, next_position),
        });
        position = next_position;

        next_position = message.sender[1] * (4/3);
        data = message.message.slice(position, next_position);
        parts.push({
          title: 'Sender',
          color: '#911eb4',
          plain: base64URLdecode(data).slice((message.sender[0] * (4/3) - position) * (3/4)),
          data,
        });
        position = next_position;

        if (message.receiver) {
          next_position = message.receiver[1] * (4/3);
          data = message.message.slice(position, next_position);
          parts.push({
            title: 'Receiver',
            color: '#000075',
            plain: base64URLdecode(data).slice((message.receiver[0] * (4/3) - position) * (3/4)),
            data,
          });
          position = next_position;
        }

        if (message.nonconfidential_data) {
          next_position = message.nonconfidential_data[1] * (4/3);
          data = message.message.slice(position, next_position),
          parts.push({
            title: 'Nonconfidential data',
            color: '#3cb44b',
            plain: base64URLdecode(data).slice((message.nonconfidential_data[0] * (4/3) - position) * (3/4)),
            data,
          });
          position = next_position;
        }

        if (message.ciphertext) {
          next_position = message.ciphertext[1] * (4/3);
          parts.push({
            title: 'Ciphertext',
            color: '#9A6324',
            plain: message.payload,
            data: message.message.slice(position, next_position),
          });
          position = next_position;
        }

        parts.push({
          title: 'Signature',
          color: '#469990',
          prefix: 4,
          data: message.message.slice(position),
        });

        card.innerHTML = `
          <div class="card mb-4 text-bg-light" style="max-width:40rem">
            <div class="card-body">
              <h5 class="card-title">Message</h5>
              <p class="card-text">
                ${parts.map(({ data, color, prefix }) => (
                  `<span class="message-part" style="color:${color}"><strong>${data.slice(0, prefix)}</strong>${data.slice(prefix)}</span>`
                )).join('')}
              </p>
              <ul class="list-group list-group-flush">
                ${parts.map(({ data, color, title, prefix, plain }) => (`
                <li class="list-group-item d-block mb-2">
                    <span class="text-muted d-block">${title}:</span>
                    ${plain ? ` <span class="text-emphasis d-block">${plain}</span>` : ''}
                    <span class="message-part" style="color:${color}">
                      <strong>${data.slice(0, prefix)}</strong>${data.slice(prefix)}
                    </span>
                </li>`)).join("\n")}
              </ul>
            </div>
          </div>`;

        return card;
      }

      // create form
      const createForm = document.getElementById('create-identity');

      createForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new URLSearchParams(new FormData(createForm));
        const response = await fetch('/create-identity', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body: formData
        });

        if (response.ok) {
          createForm.reset();
          const identity = await response.json();
          const key = identity.id;
          window.localStorage.setItem(key, JSON.stringify(identity));
          updateIdentities();
        } else {
          window.alert('Failed to create identity');
        }
      });

      // resolve form
      const resolveForm = document.getElementById('resolve-vid');

      resolveForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new URLSearchParams(new FormData(resolveForm));
        const response = await fetch('/resolve-vid', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body: formData
        });

        if (response.ok) {
          resolveForm.reset();
          const identity = await response.json();
          const key = identity.id;
          window.localStorage.setItem(key, JSON.stringify(identity));
          updateIdentities();
        } else {
          window.alert('Failed to resolve VID');
        }
      });

      // send message form
      const sendMessageForm = document.getElementById('send-message');

      sendMessageForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        if (!sendMessageForm.sender.value || !sendMessageForm.receiver.value) {
          return alert('Please select sender and receiver');
        }

        if (!window.localStorage.getItem(sendMessageForm.sender.value)) {
          return alert('Sender identity not found');
        }

        if (!window.localStorage.getItem(sendMessageForm.receiver.value)) {
          return alert('Receiver identity not found');
        }

        const formData = {
          sender: JSON.parse(window.localStorage.getItem(sendMessageForm.sender.value)),
          receiver: JSON.parse(window.localStorage.getItem(sendMessageForm.receiver.value)),
          nonconfidential_data: sendMessageForm.nonconfidential.value,
          message: sendMessageForm.message.value,
        };
        const response = await fetch('/send-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json;charset=UTF-8'
          },
          body: JSON.stringify(formData),
        });

        if (response.ok) {
          sendMessageForm.nonconfidential.value = '';
          sendMessageForm.message.value = '';
          const message = await response.json();

          const messagesContainer = document.querySelector('.messages');
          messagesContainer.innerHTML = '';
          messagesContainer.appendChild(renderMessage(message));
        } else {
          window.alert('Failed to create the TSP message');
        }
      });

      // receive message form
      const receiveMessageForm = document.getElementById('receive-messages');

      receiveMessageForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = window.localStorage.getItem(sendMessageForm.receiver.value);

        if (!formData) {
          return window.alert('Receiver identity not found');
        }

        const response = await fetch('/receive-messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json;charset=UTF-8'
          },
          body: formData,
        });

        if (!response.ok) {
          return window.alert('Failed to create the TSP message');
        }

        const messages = await response.json();

        const receivedMessagesContainer = document.querySelector('.received-messages');

        if (Object.values(messages).length === 0) {
          receivedMessagesContainer.innerHTML = `
            <div class="text-muted p-3">
              <em>None</em>
            </div>`;
        } else {
          receivedMessagesContainer.innerHTML = '';
        }

        messages.forEach((message) => {
          receivedMessagesContainer.appendChild(renderMessage(message));
        });
      });

      // initial load
      updateIdentities();
    });
  </script>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col p-3 overflow-auto">
        <h2>Test identities</h2>
        <form class="mb-4 card p-3 text-bg-light" id="create-identity">
          <div class="form-group">
            <label for="name">Create test VID:</label>
            <input type="text" id="name" name="name" pattern="[a-z]{3,100}"
              placeholder="username e.g. alice"
              title="use only lowercase characters, at least 3" class="form-control" required>
          </div>
          <div class="form-group mt-2">
            <input type="submit" value="Create test VID" class="btn btn-primary">
          </div>
        </form>
        <form class="mb-4 card p-3 text-bg-light" id="resolve-vid">
          <div class="form-group">
            <label for="vid">Resolve and verify VID:</label>
            <input type="text" id="vid" name="vid"
              placeholder="VID e.g. did:web:tsp-test.org:alice" class="form-control" required>
          </div>
          <div class="form-group mt-2">
            <input type="submit" value="Resolve and verify VID" class="btn btn-primary">
          </div>
        </form>
        <h3>Identities</h3>
        <hr>
        <div class="cards row"></div>
      </div>
      <div class="col overflow-auto border-start p-3">
        <h2>Send message</h2>
        <form class="mb-4 card p-3 text-bg-light" id="send-message">
          <div class="form-group">
            <label for="sender">Sender:</label>
            <input type="text" id="sender" sender="sender" class="form-control" />
          </div>
          <div class="form-group mt-2">
            <label for="receiver">Receiver:</label>
            <input type="text" id="receiver" name="receiver" class="form-control" />
          </div>
          <div class="form-group mt-2">
            <label for="nonconfidential">Non-confidential data:</label>
            <textarea id="nonconfidential" name="nonconfidential" class="form-control" rows="2"></textarea>
          </div>
          <div class="form-group mt-2">
            <label for="message">Message:</label>
            <textarea id="message" name="message" class="form-control" rows="4" required></textarea>
          </div>
          <div class="form-group mt-2">
            <input type="submit" value="Send message" class="btn btn-primary" />
          </div>
        </form>
        <div class="messages row"></div>
      </div>
      <div class="col overflow-auto border-start p-3">
        <h2>Receive messages</h2>
        <form class="mb-4 card p-3 text-bg-light" id="receive-messages">
          <div class="form-group mt-2">
            <label for="message-receiver">Receiver:</label>
            <input type="text" id="message-receiver" name="message-receiver" class="form-control" />
          </div>
          <div class="form-group mt-2">
            <input type="submit" value="Load messages" class="btn btn-primary" />
          </div>
        </form>
        <h3>Received messages</h3>
        <hr>
        <div class="received-messages row"></div>
      </div>
    </div>
  </div>
</body>
</html>
