<!DOCTYPE html>
<html>
  <head>
    <title>TSP Demo Server</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <style>
      html,
      body,
      body > .container-fluid,
      body > .container-fluid > .row,
      body > .container-fluid > .row > div {
        height: 100%;
      }
      .message-part {
        font-family: monospace;
        font-size: 14px;
      }
      .received-messages {
        display: flex;
        flex-direction: column-reverse;
      }
    </style>
    <script>
      async function sha256(source) {
        const sourceBytes = new TextEncoder().encode(source);
        const digest = await crypto.subtle.digest('SHA-256', sourceBytes);
        const resultBytes = [...new Uint8Array(digest)];

        return resultBytes.map((x) => x.toString(16).padStart(2, '0')).join('');
      }

      function base64URLdecode(str) {
        const base64Encoded = str.replace(/-/g, '+').replace(/_/g, '/');
        const padding =
          str.length % 4 === 0 ? '' : '='.repeat(4 - (str.length % 4));
        const base64WithPadding = base64Encoded + padding;

        return atob(base64WithPadding)
          .split('')
          .map((char) => String.fromCharCode(char.charCodeAt(0)))
          .join('');
      }

      document.addEventListener('DOMContentLoaded', () => {
        let ws = null;
        const registered = [];

        // update identities + rendering
        const updateIdentities = async () => {
          const identities = Object.keys(window.localStorage).reduce(
            (acc, item) => {
              if (item.startsWith('did:')) {
                let identity = JSON.parse(window.localStorage.getItem(item));
                const key = identity.id;

                return {
                  [key]: identity,
                  ...acc,
                };
              }

              return acc;
            },
            {}
          );

          const cards = document.querySelector('.cards');

          if (Object.values(identities).length === 0) {
            cards.innerHTML = `
            <div class="text-muted p-3">
              <em>None</em>
            </div>`;
          } else {
            cards.innerHTML = '';
          }

          Object.values(identities).forEach((identity) => {
            const card = document.createElement('div');
            card.classList.add('col');
            card.innerHTML = `
            <div class="card mb-4 text-bg-light" style="max-width:40rem">
              <div class="card-body">
                <h5 class="card-title">
                  ${identity.sigkey ? 'Private' : 'Public'} VID
                </h5>
                <input type="text" value="${identity.id}" class="form-control-plaintext" readonly />
              </div>
              <ul class="list-group list-group-flush">
                ${identity.sigkey ? `
                  <li class="list-group-item">
                      <span class="badge text-bg-warning float-end">private</span>
                      <span class="text-muted d-block mb-2">Decryption key:</span>
                      <pre class="text-warning-emphasis mb-0">${identity.enckey}</pre>
                  </li>
                  <li class="list-group-item">
                      <span class="badge text-bg-warning float-end">private</span>
                      <span class="text-muted d-block mb-2">Signing key:</span>
                      <pre class="text-warning-emphasis mb-0">${identity.sigkey}</pre>
                  </li>
                ` : ''}
                <li class="list-group-item">
                    <span class="badge text-bg-info float-end">public</span>
                    <span class="text-muted d-block mb-2">Verification key:</span>
                    <pre class="text-primary-emphasis mb-0">${identity.publicSigkey}</pre>
                </li>
                <li class="list-group-item">
                    <span class="badge text-bg-info float-end">public</span>
                    <span class="text-muted d-block mb-2">Encryption key:</span>
                    <pre class="text-primary-emphasis mb-0">${identity.publicEnckey}</pre>
                </li>
                <li class="list-group-item">
                  <span class="text-muted d-block mb-2">Transport:</span>
                  <pre class="text-primary-emphasis mb-0">${identity.transport}</pre>
                </li>
              </ul>
              <div class="card-body">
                <button role="button" class="btn btn-danger delete float-end">Delete</button>
                ${identity.sigkey ? `<button role="button" class="btn btn-warning select-sender">Select sender</button>` : ''}
                <button role="button" class="btn btn-info select-receiver">Select receiver</button>
              </div>
            </div>`;

            card.querySelector('.delete').addEventListener('click', (event) => {
              event.preventDefault();
              window.localStorage.removeItem(identity.id);
              updateIdentities();
            });

            const selectSender = card.querySelector('.select-sender');
            if (selectSender) {
              selectSender.addEventListener('click', (event) => {
                event.preventDefault();
                document.getElementById('sender').value = identity.id;
              });
            }

            card
              .querySelector('.select-receiver')
              .addEventListener('click', (event) => {
                event.preventDefault();
                document.getElementById('receiver').value = identity.id;
              });

            cards.appendChild(card);
          });

          // listen for messages on websocket
          if (!ws) {
            const proto = window.location.protocol === 'http:' ? 'ws' : 'wss';
            ws = new WebSocket(`${proto}://${window.location.host}/receive-messages`);
            ws.addEventListener('message', (event) => {
              const message = JSON.parse(event.data);
              const messagesContainer =
                document.querySelector('.received-messages');
              messagesContainer.appendChild(renderMessage(message));
            });
            ws.addEventListener('open', (event) => {
              Object.values(identities).forEach((identity) => {
                ws.send(JSON.stringify(identity));
                registered.push(identity.id);
              });
            });
          } else {
            Object.values(identities)
              .filter(({ id }) => !registered.includes(id))
              .forEach((identity) => {
                ws.send(JSON.stringify(identity));
                registered.push(identity.id);
              });
          }
        };

        function renderMessage(message) {
          const card = document.createElement('div');
          card.classList.add('col');

          const parts = ['prefix', 'sender', 'receiver', 'nonconfidentialData', 'ciphertext', 'signature'];
          const colors = ['#800000', '#911eb4', '#000075', '#3cb44b', '#9A6324', '#469990'];

          card.innerHTML = `
          <div class="card mb-4 text-bg-light" style="max-width:40rem">
            <div class="card-body">
              <span class="float-end">${(new Date()).toISOString().slice(0, 19).replace('T', ' ')}</span>
              <h5 class="card-title">Message</h5>
              <p class="card-text">
                ${parts.map((part, index) =>
                  message[part] ? `<span class="message-part" style="color:${colors[index]}">${message[part].data}</span>` : ''
                ).join('')}
              </p>
            </div>
            <ul class="list-group list-group-flush">
              ${parts.map((part, index) => message[part] ? `
                <li class="list-group-item">
                  <span class="text-muted d-block">${message[part].title}:</span>
                  ${message[part].plain ? `<span class="d-block">${message[part].plain}</span>`: ''}
                  <span class="message-part d-block" style="color:${colors[index]}">${message[part].data}</span>
                </li>
              ` : '').join('\n')}
            </ul>
          </div>`;

          return card;
        }

        // create form
        const createForm = document.getElementById('create-identity');

        createForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const formData = new URLSearchParams(new FormData(createForm));
          const response = await fetch('/create-identity', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            },
            body: formData,
          });

          if (response.ok) {
            createForm.reset();
            const identity = await response.json();
            const key = identity.id;
            window.localStorage.setItem(key, JSON.stringify(identity));
            updateIdentities();
          } else {
            window.alert('Failed to create identity');
          }
        });

        // resolve form
        const resolveForm = document.getElementById('resolve-vid');

        resolveForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const formData = new URLSearchParams(new FormData(resolveForm));
          const response = await fetch('/resolve-vid', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            },
            body: formData,
          });

          if (response.ok) {
            resolveForm.reset();
            const identity = await response.json();
            const key = identity.id;
            window.localStorage.setItem(key, JSON.stringify(identity));
            updateIdentities();
          } else {
            window.alert('Failed to resolve VID');
          }
        });

        // send message form
        const sendMessageForm = document.getElementById('send-message');

        sendMessageForm.addEventListener('submit', async (event) => {
          event.preventDefault();

          if (
            !sendMessageForm.sender.value ||
            !sendMessageForm.receiver.value
          ) {
            return alert('Please select sender and receiver');
          }

          if (!window.localStorage.getItem(sendMessageForm.sender.value)) {
            return alert('Sender identity not found');
          }

          if (!window.localStorage.getItem(sendMessageForm.receiver.value)) {
            return alert('Receiver identity not found');
          }

          const formData = {
            sender: JSON.parse(
              window.localStorage.getItem(sendMessageForm.sender.value)
            ),
            receiver: JSON.parse(
              window.localStorage.getItem(sendMessageForm.receiver.value)
            ),
            nonconfidential_data: sendMessageForm.nonconfidential.value,
            message: sendMessageForm.message.value,
          };
          const response = await fetch('/send-message', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json;charset=UTF-8',
            },
            body: JSON.stringify(formData),
          });

          if (response.ok) {
            sendMessageForm.nonconfidential.value = '';
            sendMessageForm.message.value = '';
            const message = await response.json();

            const messagesContainer = document.querySelector('.messages');
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(renderMessage(message));
          } else {
            window.alert('Failed to create the TSP message');
          }
        });

        // initial load
        updateIdentities();
      });
    </script>
  </head>

  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col p-3 overflow-auto">
          <h2>Test identities</h2>
          <form class="mb-4 card p-3 text-bg-light" id="create-identity">
            <div class="form-group">
              <label for="name">Create test VID:</label>
              <input
                type="text"
                id="name"
                name="name"
                pattern="[a-z]{3,100}"
                placeholder="username e.g. alice"
                title="use only lowercase characters, at least 3"
                class="form-control"
                required
              />
            </div>
            <div class="form-group mt-2">
              <input
                type="submit"
                value="Create test VID"
                class="btn btn-primary"
              />
            </div>
          </form>
          <form class="mb-4 card p-3 text-bg-light" id="resolve-vid">
            <div class="form-group">
              <label for="vid">Resolve and verify VID:</label>
              <input
                type="text"
                id="vid"
                name="vid"
                placeholder="VID e.g. did:web:tsp-test.org:alice"
                class="form-control"
                required
              />
            </div>
            <div class="form-group mt-2">
              <input
                type="submit"
                value="Resolve and verify VID"
                class="btn btn-primary"
              />
            </div>
          </form>
          <h3>Identities</h3>
          <hr />
          <div class="cards row"></div>
        </div>
        <div class="col overflow-auto border-start p-3">
          <h2>Send message</h2>
          <form class="mb-4 card p-3 text-bg-light" id="send-message">
            <div class="form-group">
              <label for="sender">Sender:</label>
              <input
                type="text"
                id="sender"
                sender="sender"
                class="form-control"
              />
            </div>
            <div class="form-group mt-2">
              <label for="receiver">Receiver:</label>
              <input
                type="text"
                id="receiver"
                name="receiver"
                class="form-control"
              />
            </div>
            <div class="form-group mt-2">
              <label for="nonconfidential">Non-confidential data:</label>
              <textarea
                id="nonconfidential"
                name="nonconfidential"
                class="form-control"
                rows="2"
              ></textarea>
            </div>
            <div class="form-group mt-2">
              <label for="message">Message:</label>
              <textarea
                id="message"
                name="message"
                class="form-control"
                rows="4"
                required
              ></textarea>
            </div>
            <div class="form-group mt-2">
              <input
                type="submit"
                value="Send message"
                class="btn btn-primary"
              />
            </div>
          </form>
          <div class="messages row"></div>
        </div>
        <div class="col overflow-auto border-start p-3">
          <h3>Received messages</h3>
          <hr />
          <div class="received-messages row"></div>
        </div>
      </div>
    </div>
  </body>
</html>
